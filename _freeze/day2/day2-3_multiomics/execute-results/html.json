{
  "hash": "8d3336f120194b59b817d597dcd4b1a4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 6\"\neditor: source\neditor_options: \n  chunk_output_type: console\n---\n\n# Integrating ATAC and RNA sequencing data\n\n## Learning Objectives\n\n\n## Load Libraries\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ComplexHeatmap)\nlibrary(EnrichedHeatmap)\nlibrary(circlize)\nlibrary(SummarizedExperiment)\n```\n:::\n\n\n\n## Load required objects from previous exercises\nHere we load the `SummarizedExperiment` for the ChIP-seq data\n\n::: {.cell}\n\n```{.r .cell-code}\natac <- readRDS(\"data/atac_se.rds\")\nh3k4me3 <- readRDS(\"data/h3k4me3_se.rds\")\nh3k4me1 <- readRDS(\"data/h3k4me1_se.rds\")\nh3k27me3 <- readRDS(\"data/h3k27me3_se.rds\")\nh3k27ac <- readRDS(\"data/h3k27ac_se.rds\")\nrna <- readRDS(\"data/rna_se.rds\")\nrownames(colData(rna)) <- gsub(pattern = \"\\\\.tsv.gz\", replacement = \"\", x = rownames(colData(rna)))\n\noverlap <- readRDS(\"output/overlap_anno.rds\")\n\nmat_ATAC <- readRDS(\"./output/mat_atac.rds\")\nmat_RNA <- readRDS(\"./output/mat_rna.rds\")\nmat_H3K4me3 <- readRDS(\"./output/mat_h3k4me3.rds\")\nmat_H3K4me1 <- readRDS(\"./output/mat_h3k4me1.rds\")\nmat_H3K27me3 <- readRDS(\"./output/mat_h3k27me3.rds\")\nmat_H3K27ac <- readRDS(\"./output/mat_h3k27ac.rds\")\nmat_BS <- readRDS(\"./output/mat_bs.rds\")\n```\n:::\n\n\n\n## Regulatory regions\n### Gained Enhancers (E15.5 > E11.5)\n\n::: {.cell}\n\n```{.r .cell-code}\nlogFC_cols <- grep(pattern = \"logFC\", x = colnames(elementMetadata(overlap)))\nmcols(overlap)[, logFC_cols] <- lapply(mcols(overlap)[, logFC_cols, drop = FALSE], function(x) {\n  x[is.na(x)] <- 0\n  return(x)\n})\n\ngained_enhancers <- overlap$ATAC_logFC > 0 & \n  overlap$H3K4me1_logFC > 0 & \n  overlap$H3K27ac_logFC > 0 & \n  is.na(overlap$H3K4me3_annotation) &\n  overlap$ATAC_distanceToTSS > 2500 & \n  overlap$RNA_logFC > 0\n\noverlap$ATAC_RNA[gained_enhancers] <- \"Gained Enhancers\"\n```\n:::\n\n\n## Lost Enhancers (E15.5 < E11.5)\n\n::: {.cell}\n\n```{.r .cell-code}\nlost_enhancers <- overlap$ATAC_logFC < 0 & \n  overlap$H3K4me1_logFC < 0 & \n  overlap$H3K27ac_logFC < 0 & \n  is.na(overlap$H3K4me3_annotation) &\n  overlap$ATAC_distanceToTSS > 2500 & \n  overlap$RNA_logFC < 0\n\noverlap$ATAC_RNA[lost_enhancers] <- \"Lost Enhancers\"\n```\n:::\n\n\n## Activated Promoters (E15.5 > E11.5)\n\n::: {.cell}\n\n```{.r .cell-code}\nactive_promoters <- overlap$ATAC_logFC > 0 & \n  overlap$H3K4me3_logFC > 0 & \n  overlap$H3K27ac_logFC > 0 & \n  overlap$ATAC_distanceToTSS < 2500 & \n  overlap$RNA_logFC > 0\n\noverlap$ATAC_RNA[active_promoters] <- \"Active Promoters\"\n```\n:::\n\n\n## Repressed Promoters (E15.5 < E11.5)\n\n::: {.cell}\n\n```{.r .cell-code}\nrepressed_promoters <- overlap$ATAC_logFC < 0 & \n  overlap$H3K4me3_logFC < 0 & \n  overlap$H3K27ac_logFC < 0 & \n  overlap$H3K27me3_logFC > 0 & \n  overlap$ATAC_distanceToTSS < 2500 & \n  overlap$RNA_logFC < 0\n\noverlap$ATAC_RNA[repressed_promoters] <- \"Repressed Promoters\"\n```\n:::\n\n\n## Save the file\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(object = overlap, file = \"output/overlap_anno2.rds\")\n```\n:::\n\n\n\n## `EnrichedHeatmap` + `ComplexHeatmap`\n\n### Our function from previous exercise\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_EH <- function(norm_mat, heatmap_cols = c(\"white\", \"red\"), split_rows = NULL, hm_name, col_fill = \"#ffcccc\"){\n  \n  if(length(heatmap_cols) == 2){\n    col_fun <- colorRamp2(quantile(norm_mat, c(0.01, 0.99), na.rm = T), heatmap_cols)   \n  } else if(length(heatmap_cols) == 3){\n  col_fun <- colorRamp2(quantile(mat_BS$WGBS_11half, c(0.01, 0.5, 0.99), na.rm = T), heatmap_cols)\n  } else{\n    message(\"Please update function!\")\n  }\n  \n  vmin <- as.numeric(quantile(norm_mat, c(0.01), na.rm = T))\n  vmax <- as.numeric(quantile(norm_mat, c(0.99), na.rm = T))\n  vmid <- (vmin + vmax) / 2\n  legend_ticks <- c(vmin, vmid, vmax)\n\nEnrichedHeatmap(\n  mat = norm_mat,\n  name = hm_name,\n  row_split = split_rows,\n  col = col_fun,\n  width = unit(2, \"cm\"),\n  height = unit(8, \"cm\"),\n  column_title = hm_name,\n  column_title_gp = gpar(fontsize = 8, fill = col_fill),\n  axis_name = c(\"-1kb\", \"mid\", \"1kb\"),\n  heatmap_legend_param = list(\n    at = legend_ticks,\n    legend_height = unit(0.5, \"cm\"),\n    legend_width = unit(0.1, \"cm\"),\n    labels = round(legend_ticks, digits = 1),\n    title_gp = gpar(fontsize = 8),\n    labels_gp = gpar(fontsize = 7)\n  ),\n  top_annotation = HeatmapAnnotation(\n    lines = anno_enriched(\n      height = unit(1, \"cm\"),\n      axis_param = list(\n        side = \"right\",\n        facing = \"inside\",\n        gp = gpar(\n          fontsize = 7,\n          lwd = 0.4\n        )\n      )\n    )\n  )\n)\n}\n```\n:::\n\n\n\n### ATAC\n\n::: {.cell}\n\n```{.r .cell-code}\natac_11h <- make_EH(norm_mat = mat_ATAC$ATAC_11half, hm_name = \"AS-E11.5\", col_fill = \"#ffcccc\")\natac_15h <- make_EH(norm_mat = mat_ATAC$ATAC_15half, hm_name = \"AS-E15.5\", col_fill = \"#e6fff2\")\n```\n:::\n\n\n\n### H3K4me3\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k4me3_11h <- make_EH(norm_mat = mat_H3K4me3$H3K4me3_11half, hm_name = \"K4me3-E11.5\", col_fill = \"#ffcccc\",\n                       heatmap_cols = c(\"white\", \"darkgreen\"))\nh3k4me3_15h <- make_EH(norm_mat = mat_H3K4me3$H3K4me3_15half, hm_name = \"K4me3-E15.5\", col_fill = \"#e6fff2\",\n                       heatmap_cols = c(\"white\", \"darkgreen\"))\n```\n:::\n\n\n### H3K4me1\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k4me1_11h <- make_EH(norm_mat = mat_H3K4me1$H3K4me1_11half, hm_name = \"K4me1-E11.5\", col_fill = \"#ffcccc\",\n                       heatmap_cols = c(\"white\", \"blue\"))\nh3k4me1_15h <- make_EH(norm_mat = mat_H3K4me1$H3K4me1_15half, hm_name = \"K4me1-E15.5\", col_fill = \"#e6fff2\",\n                       heatmap_cols = c(\"white\", \"blue\"))\n```\n:::\n\n\n### H3K27me3\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k27me3_11h <- make_EH(norm_mat = mat_H3K27me3$H3K27me3_11half, hm_name = \"K27me3-E11.5\", col_fill = \"#ffcccc\",\n                        heatmap_cols = c(\"white\", \"purple\"))\nh3k27me3_15h <- make_EH(norm_mat = mat_H3K27me3$H3K27me3_15half, hm_name = \"K27me3-E15.5\", col_fill = \"#e6fff2\",\n                        heatmap_cols = c(\"white\", \"purple\"))\n```\n:::\n\n\n### H3K27ac\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k27ac_11h <- make_EH(norm_mat = mat_H3K27ac$H3K27ac_11half, hm_name = \"K27ac-E11.5\", col_fill = \"#ffcccc\",\n                       heatmap_cols = c(\"white\", \"brown\"))\nh3k27ac_15h <- make_EH(norm_mat = mat_H3K27ac$H3K27ac_15half, hm_name = \"K27ac-E15.5\", col_fill = \"#e6fff2\",\n                       heatmap_cols = c(\"white\", \"brown\"))\n```\n:::\n\n\n### Methylation\n\n::: {.cell}\n\n```{.r .cell-code}\nmeth_11h <- make_EH(norm_mat = mat_BS$WGBS_11half, hm_name = \"BS-E11.5\", col_fill = \"#ffcccc\",\n                    heatmap_cols = c(\"red\", \"white\", \"blue\"))\nmeth_15h <- make_EH(norm_mat = mat_BS$WGBS_15half, hm_name = \"BS-E15.5\", col_fill = \"#e6fff2\",\n                    heatmap_cols = c(\"red\", \"white\", \"blue\"))\n```\n:::\n\n\n### Annotation\n\n::: {.cell}\n\n```{.r .cell-code}\nsplit_anno <- overlap$ATAC_RNA\nnames(split_anno) <- names(overlap)\n\nunique(split_anno)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"Active Promoters\"    \"Inc. Acc.\"           \"Dec. Acc.\"          \n [4] \"Incongruent\"         \"Silent\"              \"Active\"             \n [7] \"Repressed\"           \"Gained Enhancers\"    \"Lost Enhancers\"     \n[10] \"Repressed Promoters\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsplit_anno <- factor(split_anno, levels = unique(split_anno)[c(1,10,6,7,8,9,5,4,2,3)])\n\ncols_an <- RColorBrewer::brewer.pal(n = length(unique(split_anno)), name = \"Paired\")\n\nrow_order_eh <- row_order(atac_11h)\n\nanno_hm <- Heatmap(\n  mat = split_anno,\n  col = cols_an, \n  name = \"Annotation\",\n  show_row_names = FALSE, \n  show_column_names = FALSE, \n  width = unit(2, \"mm\"),\n  height = unit(8, \"cm\"),\n  row_order = row_order_eh,\n  row_title_gp = gpar(fontsize = 0)\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThere are 10 unique colors in the vector `col` and 10 unique values in\n`matrix`. `Heatmap()` will treat it as an exact discrete one-to-one\nmapping. If this is not what you want, slightly change the number of\ncolors, e.g. by adding one more color or removing a color.\n```\n\n\n:::\n:::\n\n\n\n### RNA\n\n::: {.cell}\n\n```{.r .cell-code}\nrna_hm <- Heatmap(matrix = mat_RNA, \n        name = \"RNA\", \n        cluster_columns = FALSE, \n        cluster_rows = FALSE,\n        na_col = \"grey\",\n        row_order = row_order_eh,\n        show_row_names = FALSE, \n        show_column_names = FALSE,\n        row_title_rot = 0,\n        top_annotation = HeatmapAnnotation(\n          df = colData(rna)[,2,drop = FALSE], \n          annotation_name_gp = gpar(fontsize = 0)\n        ),\n        width = unit(2, \"cm\"),\n        height = unit(18, \"cm\"),\n        heatmap_legend_param = list(\n          legend_height = unit(0.5, \"cm\"),\n          legend_width = unit(0.1, \"cm\"),\n          at = c(-10,0,10), \n          title = \"RNA\",\n          title_gp = gpar(fontsize = 8),\n          labels_gp = gpar(fontsize = 7)\n        )\n)\n```\n:::\n\n\n### Combine plots\n\n::: {.cell}\n\n```{.r .cell-code}\nht_opt$TITLE_PADDING <- unit(1, \"mm\")\nht_opt$legend_gap <- unit(3, \"mm\")\nht_opt$legend_grid_height <- unit(2, \"mm\")\nht_opt$legend_grid_width <- unit(2, \"mm\")\nht_opt$HEATMAP_LEGEND_PADDING <- unit(1, \"mm\")\nht_opt$heatmap_border <- TRUE\n\ndraw(\n  anno_hm + \n    atac_11h + atac_15h + \n    h3k4me3_11h + h3k4me3_15h + \n    h3k4me1_11h + h3k4me1_15h + \n    h3k27me3_11h + h3k27me3_15h + \n    h3k27ac_11h + h3k27ac_15h + \n    rna_hm +\n    meth_11h + meth_15h, \n  split = split_anno, \n  merge_legend = FALSE,\n  heatmap_legend_side = \"bottom\"\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npdf(file = \"output/final_heatmap.pdf\", width = 22, height = 17)\ngrid.newpage()\npushViewport(viewport(gp = gpar(lwd = 0.5)))\ndraw(\n  anno_hm + \n    atac_11h + atac_15h + \n    h3k4me3_11h + h3k4me3_15h + \n    h3k4me1_11h + h3k4me1_15h + \n    h3k27me3_11h + h3k27me3_15h + \n    h3k27ac_11h + h3k27ac_15h + \n    rna_hm +\n    meth_11h + meth_15h, \n  split = split_anno, \n  merge_legend = FALSE,\n  heatmap_legend_side = \"bottom\"\n)\npopViewport()\n\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nquartz_off_screen \n                2 \n```\n\n\n:::\n\n```{.r .cell-code}\npng(filename = \"output/final_heatmap.png\", width = 27, height = 22, units = \"in\", res = 330)\ngrid.newpage()\npushViewport(viewport(gp = gpar(lwd = 0.5)))\ndraw(\n  anno_hm + \n    atac_11h + atac_15h + \n    h3k4me3_11h + h3k4me3_15h + \n    h3k4me1_11h + h3k4me1_15h + \n    h3k27me3_11h + h3k27me3_15h + \n    h3k27ac_11h + h3k27ac_15h + \n    rna_hm +\n    meth_11h + meth_15h, \n  split = split_anno, \n  merge_legend = FALSE,\n  heatmap_legend_side = \"bottom\"\n)\npopViewport()\n\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nquartz_off_screen \n                2 \n```\n\n\n:::\n:::\n\n\n## Question\n**Look at the plot carefully and try to understand patterns. Can you confirm from the plot that the plot is correct for the `Active Promoters`?**\n\n\n:::{.callout-important}\nYou can make all possible categories from this `overlapMatrix`. Feel free to make more categories.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}